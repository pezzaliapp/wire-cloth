<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wire Cloth + Afro Groove (Hybrid)</title>

<style>
html,body{
  margin:0;height:100%;
  background:#050805;
  overflow:hidden;
  touch-action:none;
}
canvas{
  display:block;
  width:100vw;
  height:100vh;
}
.hud{
  position:fixed;
  left:12px;top:12px;
  z-index:10;
  font:13px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  color:#b6ffbf;
  background:rgba(0,0,0,.35);
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(182,255,191,.25);
}
.hud b{color:#d7ffdd}
.btn{
  display:inline-block;
  margin:6px 4px 0 0;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid rgba(182,255,191,.35);
  cursor:pointer;
  user-select:none;
}
.btn.active{
  background:rgba(120,255,140,.25);
}
.small{font-size:11px;opacity:.85}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div class="hud" id="hud">
  <b>Wire Cloth + Afro Groove (Hybrid)</b><br>
  Hold & drag = crea vuoti + groove (ovunque)<br>
  Banda bassa = editor preciso<br>
  Shift = taglia • Doppio tap = reset<br>

  <div class="btn" id="audioBtn">▶ START AUDIO</div>
  <div class="btn small" id="eraseBtn">ERASE: OFF</div>
</div>

<script>
(()=>{

/* -------------------------------------------------- */
/* BASIC SETUP                                        */
/* -------------------------------------------------- */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d',{alpha:false});
const audioBtn = document.getElementById('audioBtn');
const eraseBtn = document.getElementById('eraseBtn');

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
let W,H,DPR;

function resize(){
  DPR=Math.min(2,devicePixelRatio||1);
  W=innerWidth|0; H=innerHeight|0;
  canvas.width=W*DPR; canvas.height=H*DPR;
  canvas.style.width=W+'px';
  canvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize',resize);
resize();

/* -------------------------------------------------- */
/* CLOTH                                              */
/* -------------------------------------------------- */
let SPACING=16, COLS=50, ROWS=28;
let GRAV=0.4, FRICTION=0.992;
let ITER=5, TEAR_DIST=32;
let FIELD_R=90, FIELD_STRENGTH=3.0;

class Point{
  constructor(x,y,p=false){
    this.x=x; this.y=y;
    this.px=x; this.py=y;
    this.pinned=p;
  }
  step(){
    if(this.pinned) return;
    const vx=(this.x-this.px)*FRICTION;
    const vy=(this.y-this.py)*FRICTION;
    this.px=this.x; this.py=this.y;
    this.x+=vx;
    this.y+=vy+GRAV;
  }
}
class Link{
  constructor(a,b,r){
    this.a=a; this.b=b; this.r=r; this.on=true;
  }
  solve(){
    if(!this.on) return;
    const dx=this.b.x-this.a.x;
    const dy=this.b.y-this.a.y;
    const d=Math.hypot(dx,dy);
    if(d>TEAR_DIST){this.on=false;return;}
    const diff=(d-this.r)/d;
    const ox=dx*0.5*diff;
    const oy=dy*0.5*diff;
    if(!this.a.pinned){this.a.x+=ox;this.a.y+=oy;}
    if(!this.b.pinned){this.b.x-=ox;this.b.y-=oy;}
  }
}

let points=[],links=[];
function buildCloth(){
  points=[];links=[];
  const sx=(W-(COLS-1)*SPACING)/2;
  const sy=H*0.12;
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const p=new Point(
        sx+x*SPACING,
        sy+y*SPACING,
        y===0 && x%2===0
      );
      points.push(p);
    }
  }
  const id=(x,y)=>points[y*COLS+x];
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(x<COLS-1) links.push(new Link(id(x,y),id(x+1,y),SPACING));
      if(y<ROWS-1) links.push(new Link(id(x,y),id(x,y+1),SPACING));
      if(x<COLS-1&&y<ROWS-1){
        const d=Math.hypot(SPACING,SPACING);
        links.push(new Link(id(x,y),id(x+1,y+1),d));
        links.push(new Link(id(x+1,y),id(x,y+1),d));
      }
    }
  }
}
buildCloth();

/* -------------------------------------------------- */
/* GROOVE                                             */
/* -------------------------------------------------- */
const STEPS=16;
const TRACKS=5; // kick clap shaker conga bass
let bpm=123;
let swing=0.58;
const pattern=Array.from({length:TRACKS},()=>Array(STEPS).fill(0));

function afroPreset(){
  pattern.forEach(r=>r.fill(0));
  [0,3,7,8,11,14].forEach(s=>pattern[0][s]=1);
  [4,12,15].forEach(s=>pattern[1][s]=1);
  [1,2,3,5,6,7,9,10,11,13,14,15].forEach(s=>pattern[2][s]=1);
  [2,6,10,13].forEach(s=>pattern[3][s]=1);
  [0,7,10,15].forEach(s=>pattern[4][s]=1);
}
afroPreset();

function grooveBand(){
  const h=clamp(H*0.22,120,220);
  return {x:20,y:H-h-20,w:W-40,h};
}

/* -------------------------------------------------- */
/* POINTER                                            */
/* -------------------------------------------------- */
const pointer={x:0,y:0,down:false,shift:false};
let eraseMode=false;

eraseBtn.onclick=()=>{
  eraseMode=!eraseMode;
  eraseBtn.textContent=eraseMode?"ERASE: ON":"ERASE: OFF";
  eraseBtn.classList.toggle("active",eraseMode);
};

function setPointer(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  pointer.x=t.clientX-r.left;
  pointer.y=t.clientY-r.top;
}

canvas.addEventListener('pointerdown',e=>{
  setPointer(e);
  pointer.down=true;
  pointer.shift=e.shiftKey;
});
canvas.addEventListener('pointermove',e=>{
  if(!pointer.down)return;
  setPointer(e);
});
canvas.addEventListener('pointerup',()=>pointer.down=false);

/* -------------------------------------------------- */
/* GROOVE PAINT (IBRIDO)                              */
/* -------------------------------------------------- */
function paintGroove(){
  if(!pointer.down||pointer.shift)return;

  const band=grooveBand();
  const inBand=
    pointer.x>band.x&&pointer.x<band.x+band.w &&
    pointer.y>band.y&&pointer.y<band.y+band.h;

  if(inBand){
    const c=clamp(((pointer.x-band.x)/band.w*STEPS)|0,0,STEPS-1);
    const r=clamp(((pointer.y-band.y)/band.h*TRACKS)|0,0,TRACKS-1);
    pattern[r][c]=eraseMode?0:1;
  }else{
    const c=clamp((pointer.x/W*STEPS)|0,0,STEPS-1);
    const r=clamp((pointer.y/H*TRACKS)|0,0,TRACKS-1);
    pattern[r][c]=eraseMode?0:1;
  }
}

/* -------------------------------------------------- */
/* AUDIO (AFRO HOUSE)                                 */
/* -------------------------------------------------- */
let audio=null;
function createAudio(){
  const AC=window.AudioContext||window.webkitAudioContext;
  const ac=new AC({latencyHint:"interactive"});
  const master=ac.createGain();
  master.gain.value=0.35;
  master.connect(ac.destination);

  const noise=ac.createBuffer(1,ac.sampleRate,ac.sampleRate);
  const d=noise.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;

  const env=(t,a,d,p)=>{
    const g=ac.createGain();
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(p,t+a);
    g.gain.exponentialRampToValueAtTime(0.0001,t+a+d);
    return g;
  };

  function kick(t){
    const o=ac.createOscillator();
    o.frequency.setValueAtTime(120,t);
    o.frequency.exponentialRampToValueAtTime(45,t+0.18);
    o.connect(env(t,0.003,0.18,1)).connect(master);
    o.start(t);o.stop(t+0.3);
  }
  function clap(t){
    const s=ac.createBufferSource();s.buffer=noise;
    const bp=ac.createBiquadFilter();
    bp.type="bandpass";bp.frequency.value=2200;
    s.connect(bp).connect(env(t,0.002,0.12,0.7)).connect(master);
    s.start(t);s.stop(t+0.15);
  }
  function shaker(t){
    const s=ac.createBufferSource();s.buffer=noise;
    const hp=ac.createBiquadFilter();
    hp.type="highpass";hp.frequency.value=7000;
    s.connect(hp).connect(env(t,0.001,0.04,0.25)).connect(master);
    s.start(t);s.stop(t+0.06);
  }
  function conga(t){
    const o=ac.createOscillator();
    o.frequency.setValueAtTime(190,t);
    o.frequency.exponentialRampToValueAtTime(120,t+0.12);
    o.connect(env(t,0.003,0.14,0.5)).connect(master);
    o.start(t);o.stop(t+0.2);
  }
  function bass(t,s){
    const o=ac.createOscillator();
    const notes=[55,65,73,82];
    o.frequency.value=notes[s%4];
    o.type="triangle";
    o.connect(env(t,0.01,0.25,0.4)).connect(master);
    o.start(t);o.stop(t+0.4);
  }

  let step=0,next=0;
  const look=0.12;

  function sched(){
    const spb=60/bpm;
    const base=spb/4;
    while(next<ac.currentTime+look){
      const off=step%2?base*(swing-0.5):0;
      const t=next+off;
      if(pattern[0][step])kick(t);
      if(pattern[1][step])clap(t);
      if(pattern[2][step])shaker(t);
      if(pattern[3][step])conga(t);
      if(pattern[4][step])bass(t,step);
      step=(step+1)%STEPS;
      next+=base;
    }
  }

  let timer=null;
  return{
    ac,
    start(){
      if(timer)return;
      next=ac.currentTime+0.05;
      timer=setInterval(sched,25);
    },
    stop(){
      clearInterval(timer);timer=null;
    },
    running:()=>!!timer
  };
}

audioBtn.onclick=async()=>{
  if(!audio){
    audio=createAudio();
    await audio.ac.resume();
    audio.start();
    audioBtn.textContent="■ STOP AUDIO";
    return;
  }
  if(audio.running()){
    audio.stop();
    audioBtn.textContent="▶ START AUDIO";
  }else{
    await audio.ac.resume();
    audio.start();
    audioBtn.textContent="■ STOP AUDIO";
  }
};

/* -------------------------------------------------- */
/* LOOP                                               */
/* -------------------------------------------------- */
function frame(){
  ctx.fillStyle="#050805";
  ctx.fillRect(0,0,W,H);

  points.forEach(p=>p.step());
  if(pointer.down&&!pointer.shift){
    for(const p of points){
      const dx=p.x-pointer.x;
      const dy=p.y-pointer.y;
      const d=Math.hypot(dx,dy);
      if(d<FIELD_R){
        const f=(1-d/FIELD_R)*FIELD_STRENGTH;
        p.x+=dx/d*f*6;
        p.y+=dy/d*f*6;
      }
    }
  }
  paintGroove();

  for(let i=0;i<ITER;i++){
    links.forEach(l=>l.solve());
  }

  ctx.strokeStyle="rgba(120,255,140,.85)";
  links.forEach(l=>{
    if(!l.on)return;
    ctx.beginPath();
    ctx.moveTo(l.a.x,l.a.y);
    ctx.lineTo(l.b.x,l.b.y);
    ctx.stroke();
  });

  const band=grooveBand();
  ctx.fillStyle="rgba(0,0,0,.35)";
  ctx.fillRect(band.x,band.y,band.w,band.h);

  for(let r=0;r<TRACKS;r++){
    for(let s=0;s<STEPS;s++){
      if(pattern[r][s]){
        const x=band.x+s/STEPS*band.w;
        const y=band.y+r/TRACKS*band.h;
        ctx.fillStyle="rgba(120,255,140,.3)";
        ctx.fillRect(x+2,y+2,band.w/STEPS-4,band.h/TRACKS-4);
      }
    }
  }

  requestAnimationFrame(frame);
}
frame();

})();
</script>
</body>
</html>
